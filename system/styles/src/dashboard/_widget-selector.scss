// Widget Selector Modal Styles
@use "../variables" as *;
@use "../counter-card";

// Widget Selector Modal
#widget-selector-modal {
  .modal-dialog {
    max-width: 900px;
  }

  .modal-content {
    max-height: 85vh;
    display: flex;
    flex-direction: column;
  }

  .modal-header {
    flex-shrink: 0;
    border-bottom: 1px solid var(--dgc-border-color);

    .modal-title-wrapper {
      display: flex;
      align-items: baseline;
      gap: $spacing-sm;
    }

    .modal-title {
      margin: 0;
      font-size: $font-size-lg;
      font-weight: $font-weight-medium;
    }

    .modal-subtitle {
      font-size: $font-size-sm;
      color: var(--dgc-text-hint);
    }
  }

  .modal-body {
    display: flex;
    padding: 0;
    overflow: hidden;
    flex: 1;
    min-height: 0;
  }

  // Left sidebar - category and type filters
  .widget-sidebar {
    width: 220px;
    flex-shrink: 0;
    border-right: 1px solid var(--dgc-border-color);
    display: flex;
    flex-direction: column;
    background: var(--dgc-gray-50);
    overflow-y: auto;

    .sidebar-section {
      display: flex;
      flex-direction: column;

      &:not(:last-child) {
        border-bottom: 1px solid var(--dgc-border-color);
      }
    }

    .sidebar-header {
      padding: $spacing-sm $spacing-md;
      border-bottom: 1px solid var(--dgc-border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--dgc-bg-card);
      position: sticky;
      top: 0;
      z-index: 1;

      .sidebar-title {
        font-size: $font-size-sm;
        font-weight: $font-weight-medium;
        color: var(--dgc-text-primary);
      }

      .sidebar-actions {
        display: flex;
        gap: $spacing-xs;

        .btn-link {
          padding: 0;
          font-size: 11px;
          text-decoration: none;

          &:hover {
            text-decoration: underline;
          }
        }
      }
    }

    .sidebar-types {
      padding: $spacing-sm;
      display: flex;
      flex-wrap: wrap;
      gap: $spacing-xs;
      align-content: flex-start;
    }

    .sidebar-categories {
      flex: 1;
      padding: $spacing-sm;
      display: flex;
      flex-wrap: wrap;
      gap: $spacing-sm;
      align-content: flex-start;
    }

    // Type chips
    .type-chip {
      display: inline-flex;
      align-items: center;
      gap: $spacing-xs;
      padding: 4px $spacing-sm;
      border-radius: 50px;
      font-size: 12px;
      font-weight: $font-weight-medium;
      border: 1px solid var(--dgc-gray-400);
      background: transparent;
      color: var(--dgc-text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;

      i {
        font-size: 11px;
      }

      .chip-check-icon {
        margin-right: 2px;
      }

      .type-chip-count {
        font-size: 10px;
        opacity: 0.8;
      }

      &:hover:not(:disabled) {
        background: var(--dgc-gray-200);
        border-color: var(--dgc-gray-500);
        color: var(--dgc-text-primary);
      }

      &:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba($primary, 0.25);
      }

      &.active {
        color: #fff;
        border-color: transparent;

        &:hover:not(:disabled) {
          filter: brightness(1.1);
        }
      }

      &.disabled,
      &:disabled {
        opacity: 0.5;
        cursor: not-allowed;

        &:hover {
          background: transparent;
          filter: none;
        }
      }
    }

    // Category chips (reusing graph creator chip style)
    .category-chip {
      display: inline-flex;
      align-items: center;
      gap: $spacing-xs;
      padding: $spacing-xs $spacing-md;
      border-radius: 50px;
      font-size: $font-size-sm;
      font-weight: $font-weight-medium;
      border: 1px solid var(--dgc-gray-400);
      background: transparent;
      color: var(--dgc-text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;

      i {
        font-size: 12px;
      }

      .chip-check-icon {
        margin-right: $spacing-xs;
      }

      .category-chip-count {
        font-size: 11px;
        opacity: 0.8;
      }

      &:hover {
        background: var(--dgc-gray-200);
        border-color: var(--dgc-gray-500);
        color: var(--dgc-text-primary);
      }

      &:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba($primary, 0.25);
      }

      &.active {
        color: #fff;
        border-color: transparent;

        &:hover {
          filter: brightness(1.1);
        }
      }
    }
  }

  // Main content area
  .widget-main {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    overflow: hidden;
  }

  .widget-search {
    padding: $spacing-md;
    border-bottom: 1px solid var(--dgc-border-color);
    background: var(--dgc-bg-card);

    .search-input-wrapper {
      position: relative;

      .search-icon {
        position: absolute;
        left: $spacing-sm;
        top: 50%;
        transform: translateY(-50%);
        color: var(--dgc-text-hint);
        pointer-events: none;
      }

      .form-control {
        padding-left: 36px;
      }
    }
  }

  .widget-grid-container {
    flex: 1;
    overflow-y: auto;
    padding: $spacing-md;
  }

  .widget-grid {
    display: flex;
    flex-direction: column;
    gap: $spacing-lg;
  }

  // Widget section (grouped by type)
  .widget-section {
    display: flex;
    flex-direction: column;
    gap: $spacing-sm;
  }

  .widget-section-header {
    display: flex;
    align-items: center;
    gap: $spacing-sm;
    padding: $spacing-sm $spacing-md;
    background: color-mix(in srgb, var(--section-color, #{$primary}) 10%, var(--dgc-bg-card));
    border: 1px solid color-mix(in srgb, var(--section-color, #{$primary}) 25%, transparent);
    border-radius: $border-radius;
    position: sticky;
    top: 0;
    z-index: 5;

    i {
      font-size: 14px;
      color: var(--section-color, var(--dgc-primary));
    }

    .section-title {
      font-size: $font-size-sm;
      font-weight: $font-weight-medium;
      color: var(--dgc-text-primary);
    }

    .section-count {
      font-size: 11px;
      font-weight: $font-weight-medium;
      color: #fff;
      background: var(--section-color, var(--dgc-primary));
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: auto;
    }
  }

  .widget-section-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: $spacing-md;
  }

  // Graph/Widget cards
  .widget-card {
    position: relative;
    background: var(--dgc-bg-card);
    border: 2px solid var(--dgc-border-color);
    border-radius: $border-radius-lg;
    padding: $spacing-md;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    gap: $spacing-sm;
    min-height: 160px; // Uniform height for all cards

    &:hover {
      border-color: var(--dgc-primary-light);
      box-shadow: var(--dgc-shadow-2);
    }

    &:focus {
      outline: none;
      border-color: var(--dgc-primary);
      box-shadow: 0 0 0 3px rgba(var(--dgc-primary-rgb), 0.15);
    }

    // Current selection - highlighted with primary color
    &.selected {
      border-color: var(--dgc-primary);

      .widget-card-status {
        opacity: 1;
        visibility: visible;
      }
    }

    // Status indicator - bottom right corner check icon
    .widget-card-status {
      position: absolute;
      bottom: $spacing-sm;
      right: $spacing-sm;
      opacity: 0;
      visibility: hidden;
      transition:
        opacity 0.2s,
        visibility 0.2s;
      z-index: 10;

      i {
        font-size: 18px;
      }

      // Current selection - primary color
      &.current {
        color: var(--dgc-primary);

        i {
          color: var(--dgc-primary);
        }

        span {
          color: #fff;
        }
      }

      // Used elsewhere in dashboard - gray/muted
      &.used {
        color: var(--dgc-gray-400);

        i {
          color: var(--dgc-gray-400);
        }

        span {
          color: var(--dgc-gray-300);
        }
      }
    }

    // Style for cards used elsewhere - disabled state
    &.used-elsewhere {
      cursor: not-allowed;
      border-color: var(--dgc-gray-300);

      // Always show status overlay for used-elsewhere cards
      .widget-card-status {
        opacity: 1;
        visibility: visible;
      }

      &:hover {
        border-color: var(--dgc-gray-400);
        box-shadow: none;
      }

      &:focus {
        box-shadow: none;
        border-color: var(--dgc-gray-400);
      }
    }

    // Disabled class for additional styling
    &.disabled {
      pointer-events: auto; // Allow hover for tooltip but block click in JS
    }

    .widget-card-header {
      display: flex;
      align-items: flex-start;
      gap: $spacing-sm;
    }

    .widget-card-icon {
      width: 40px;
      height: 40px;
      border-radius: $border-radius;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;

      &.bar {
        background: rgba($primary, 0.1);
        color: $primary;
      }

      &.line {
        background: rgba($success, 0.1);
        color: $success;
      }

      &.pie {
        background: rgba($warning, 0.1);
        color: $warning;
      }

      &.area {
        background: rgba($info, 0.1);
        color: $info;
      }

      &.scatter {
        background: rgba($error, 0.1);
        color: $error;
      }

      // Counter icon uses inline style for dynamic color
      &.counter {
        .material-icons {
          font-size: 20px;
        }
      }
    }

    .widget-card-info {
      flex: 1;
      min-width: 0;
    }

    .widget-card-name {
      font-size: $font-size-sm;
      font-weight: $font-weight-medium;
      color: var(--dgc-text-primary);
      margin: 0 0 2px 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .widget-card-type {
      font-size: 11px;
      color: var(--dgc-text-hint);
      text-transform: capitalize;
    }

    .widget-card-selected-badge {
      display: none;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--dgc-primary);
      color: #fff;
      font-size: 10px;
      flex-shrink: 0;
    }

    .widget-card-description-wrapper {
      position: relative;
    }

    .widget-card-description {
      font-size: 11px;
      color: var(--dgc-text-secondary);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-height: 1.4;
      margin: 0;
    }

    .widget-card-readmore {
      background: none;
      border: none;
      padding: 0;
      margin-top: $spacing-xs;
      font-size: 11px;
      color: var(--dgc-primary);
      cursor: pointer;
      font-weight: $font-weight-medium;

      &:hover {
        text-decoration: underline;
      }
    }

    // Expanded description overlay
    .widget-card-description-expanded {
      position: absolute;
      inset: 0;
      background: var(--dgc-card-bg, #fff);
      border: 1px solid var(--dgc-border-color, #e0e0e0);
      border-radius: $border-radius;
      padding: $spacing-sm;
      display: flex;
      flex-direction: column;
      z-index: 15;
      opacity: 0;
      visibility: hidden;
      transition:
        opacity 0.2s,
        visibility 0.2s;
      box-shadow: $shadow-2;

      &.visible {
        opacity: 1;
        visibility: visible;
      }

      .description-expanded-content {
        flex: 1;
        overflow-y: auto;
        font-size: 12px;
        color: var(--dgc-text-secondary);
        line-height: 1.5;

        p {
          margin: 0;
        }
      }

      .description-expanded-close {
        position: absolute;
        bottom: $spacing-sm;
        left: $spacing-sm;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--dgc-bg-tertiary, #e0e0e0);
        border: 1px solid var(--dgc-border-color);
        border-radius: 50%;
        padding: 0;
        color: var(--dgc-text-secondary);
        cursor: pointer;
        font-size: 12px;
        line-height: 1;
        transition: all 0.2s;

        &:hover {
          background: var(--dgc-text-hint, #bdbdbd);
          color: var(--dgc-text-primary);
        }
      }
    }

    .widget-card-categories {
      margin-top: auto;
    }
  }

  // Empty state
  .widget-empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: $spacing-xl * 2;
    text-align: center;
    color: var(--dgc-text-hint);

    .empty-icon {
      font-size: 48px;
      margin-bottom: $spacing-md;
      opacity: 0.5;
    }

    .empty-title {
      font-size: $font-size-base;
      font-weight: $font-weight-medium;
      color: var(--dgc-text-secondary);
      margin-bottom: $spacing-xs;
    }

    .empty-description {
      font-size: $font-size-sm;
    }
  }

  // Loading state
  .widget-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: $spacing-xl * 2;
    gap: $spacing-md;

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--dgc-border-color);
      border-top-color: var(--dgc-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-text {
      font-size: $font-size-sm;
      color: var(--dgc-text-hint);
    }
  }
}

// Edit overlay for dashboard areas with widgets
.area-content.has-widget {
  position: relative;
  height: 100%;
  overflow: hidden; // Prevent content from expanding

  // Widget graph wrapper - contains header and chart
  .widget-graph-wrapper {
    display: flex;
    flex-direction: column;
    height: 100%;
    width: 100%;
    min-width: 0; // Allow flex child to shrink below content size
    background: var(--dgc-bg-card);
    border-radius: $border-radius-lg;
    border: 2px solid transparent;
    transition:
      border-color 0.2s ease,
      box-shadow 0.2s ease;
    overflow: hidden; // Clip any overflowing content

    &:hover {
      // border-color: var(--dgc-primary-light);
      box-shadow: var(--dgc-shadow-2);
    }
  }

  .widget-graph-header {
    padding: $spacing-sm $spacing-md;
    border-bottom: 1px solid var(--dgc-border-color);
    background: var(--dgc-gray-50);
    flex-shrink: 0;
    border-radius: $border-radius $border-radius 0 0;
    overflow: hidden; // Prevent content from expanding header

    .widget-graph-title-section {
      width: 100%;
      min-width: 0;
      overflow: hidden; // Critical for text truncation
    }

    .widget-graph-name {
      font-size: $font-size-sm;
      font-weight: $font-weight-medium;
      color: var(--dgc-text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      display: block;
    }

    .widget-graph-description {
      font-size: 11px;
      color: var(--dgc-text-secondary);
      line-height: 1.4;
      margin-top: 2px;
      width: 100%;
      overflow: hidden; // Contain the description

      // Default collapsed state - single line with ellipsis
      &.collapsed {
        display: flex;
        align-items: baseline;

        .description-text {
          flex: 1;
          min-width: 0;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
      }

      // Expanded state - full text shown
      &.expanded {
        display: block;

        .description-text {
          display: block;
          white-space: normal;
          margin-bottom: 2px;
        }
      }

      .description-toggle {
        display: none;
        color: var(--dgc-primary);
        cursor: pointer;
        font-weight: $font-weight-medium;
        white-space: nowrap;
        flex-shrink: 0;
        margin-left: $spacing-xs;

        &:hover {
          text-decoration: underline;
        }
      }

      // Show toggle only when text is actually truncated
      &.is-truncated .description-toggle {
        display: inline;
      }

      // In expanded state, always show toggle
      &.expanded .description-toggle {
        display: inline;
      }
    }
  }

  .widget-graph-container {
    flex: 1;
    min-height: 150px;
    position: relative;
  }

  // Counter widget container
  .widget-counter-container {
    flex: 1;
    min-height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: $spacing-md;
  }

  .widget-counter-loading,
  .widget-counter-display {
    width: 100%;
  }

  // Counter widget wrapper - responsive container
  .widget-counter-wrapper {
    display: flex;
    flex-direction: column;
    height: 100%;
    width: 100%;
    min-width: 0;
    background: var(--dgc-bg-card);
    border-radius: $border-radius-lg;
    border: 2px solid transparent;
    transition:
      border-color 0.2s ease,
      box-shadow 0.2s ease;
    overflow: hidden;

    &:hover {
      box-shadow: var(--dgc-shadow-2);
    }

    .widget-counter-container {
      flex: 1;
      display: flex;
      align-items: stretch;
      justify-content: stretch;
      padding: 0;
      min-height: 0;
    }
  }

  // Counter skeleton - uses shared styles with compact size
  // Note: counter-skeleton base and --compact variant are defined in _counter-card.scss

  // Counter card display - uses shared styles with compact size
  .counter-card-display {
    @extend .counter-card;
    @extend .counter-card--compact;
  }

  .widget-graph-loading {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: $spacing-sm;
    color: var(--dgc-text-hint);
    background: var(--dgc-bg-card);

    // Hide old spinner when using chart-skeleton
    &.chart-skeleton {
      .spinner,
      > span {
        display: none;
      }
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--dgc-border-color);
      border-top-color: var(--dgc-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    span {
      font-size: $font-size-sm;
    }
  }

  .widget-graph-error {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: $spacing-sm;
    color: var(--dgc-text-hint);
    background: var(--dgc-bg-card);

    i {
      font-size: 24px;
      color: $error;
      opacity: 0.6;
    }

    span {
      font-size: $font-size-sm;
    }
  }

  // Counter error - uses shared styles with compact size
  .widget-counter-error {
    @extend .counter-error;
    @extend .counter-error--compact;
  }

  // Table widget wrapper - responsive container
  .widget-table-wrapper {
    display: flex;
    flex-direction: column;
    height: 100%;
    width: 100%;
    min-width: 0;
    background: var(--dgc-bg-card);
    border-radius: $border-radius-lg;
    border: 2px solid transparent;
    transition:
      border-color 0.2s ease,
      box-shadow 0.2s ease;
    overflow: hidden;

    &:hover {
      box-shadow: var(--dgc-shadow-2);
    }

    .widget-table-header {
      padding: $spacing-sm $spacing-md;
      border-bottom: 1px solid var(--dgc-border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;

      .widget-table-name {
        font-size: $font-size-sm;
        font-weight: 600;
        color: var(--dgc-text-primary);
      }
    }

    .widget-table-container {
      flex: 1;
      overflow: auto;
      padding: $spacing-sm;
      min-height: 0;
    }
  }

  // Table skeleton - dashboard compact variant
  .widget-table-container .table-skeleton {
    .skeleton-row {
      padding: $spacing-xs $spacing-sm;
      gap: $spacing-sm;

      &.skeleton-header {
        background: var(--dgc-bg-elevated);
      }
    }

    .skeleton-cell {
      height: 12px;
    }
  }

  // Table error state
  .widget-table-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: $spacing-lg;
    text-align: center;
    color: var(--dgc-text-hint);
    min-height: 120px;

    i {
      font-size: 24px;
      color: $error;
      opacity: 0.6;
      margin-bottom: $spacing-xs;
    }

    span {
      font-size: $font-size-sm;
    }
  }

  // Table empty state
  .widget-table-empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: $spacing-lg;
    text-align: center;
    color: var(--dgc-text-hint);
    min-height: 120px;

    i {
      font-size: 24px;
      opacity: 0.4;
      margin-bottom: $spacing-xs;
    }

    span {
      font-size: $font-size-sm;
    }
  }

  .widget-edit-overlay {
    position: absolute;
    inset: 0;
    background: rgba(255, 255, 255, 0.85);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition:
      opacity 0.2s,
      visibility 0.2s;
    z-index: 20;
    border-radius: $border-radius;

    // Override center-controls positioning for overlay context
    .center-controls {
      position: static;
      transform: none;
    }
  }

  &:hover .widget-edit-overlay,
  &:focus-within .widget-edit-overlay {
    opacity: 1;
    visibility: visible;
  }
}

// Hide overlay in tweak mode (layout editing)
.dashboard-builder:not(.layout-edit-disabled) {
  .widget-edit-overlay {
    display: none !important;
  }
}

// Hide overlay in preview mode
.dashboard-preview {
  .widget-edit-overlay {
    display: none !important;
  }
}

// Responsive adjustments
@media (max-width: 768px) {
  #widget-selector-modal {
    .modal-body {
      flex-direction: column;
    }

    .widget-sidebar {
      width: 100%;
      max-height: 150px;
      border-right: none;
      border-bottom: 1px solid var(--dgc-border-color);
      flex-direction: row;
      overflow-x: auto;

      .sidebar-section {
        flex: 0 0 auto;
        flex-direction: row;
        align-items: flex-start;
        padding: $spacing-xs;
        border-bottom: none;

        &:not(:last-child) {
          border-right: 1px solid var(--dgc-border-color);
        }
      }

      .sidebar-header {
        position: static;
        padding: $spacing-xs;
        border-bottom: none;
        background: transparent;
        flex-direction: column;
        gap: 2px;

        .sidebar-title {
          font-size: 10px;
          white-space: nowrap;
        }

        .sidebar-actions {
          display: none;
        }
      }

      .sidebar-types,
      .sidebar-categories {
        padding: $spacing-xs;
        flex-wrap: nowrap;
        overflow-x: auto;
        gap: $spacing-xs;
      }
    }

    .type-chip {
      padding: 2px $spacing-sm;
      font-size: 10px;
    }

    .category-chip {
      padding: $spacing-xs $spacing-sm;
      font-size: 11px;
    }

    .widget-section-grid {
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }
  }
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}
